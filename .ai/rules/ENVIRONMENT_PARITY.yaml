# Agentic Stack Environment Parity
# Defines policies for maintaining consistency across environments

version: 1.0

# =============================================================================
# Overview
# =============================================================================
overview:
  description: >
    This document defines policies and procedures for maintaining parity
    between development, staging, and production environments to reduce
    "works on my machine" issues and deployment surprises.

  principle: >
    Development, staging, and production should be as similar as possible.
    Differences should be minimized, documented, and justified.

  goals:
    - "Predictable deployments"
    - "Reproducible issues"
    - "Consistent behavior across environments"
    - "Reduced debugging time"

# =============================================================================
# Environment Definitions
# =============================================================================
environments:

  development:
    description: "Local development environment"
    purpose: "Developer workstations, rapid iteration"
    characteristics:
      - "May use mocked services"
      - "Debug mode enabled"
      - "Local data only"
    parity_priority: medium

  staging:
    description: "Pre-production testing environment"
    purpose: "Integration testing, UAT, pre-deployment verification"
    characteristics:
      - "Mirror of production"
      - "Real services, test data"
      - "Production-like resources"
    parity_priority: high

  production:
    description: "Live production environment"
    purpose: "Serving real users/workloads"
    characteristics:
      - "Real data"
      - "Full resources"
      - "Monitoring enabled"
    parity_priority: reference  # This is the reference standard

# =============================================================================
# Parity Requirements
# =============================================================================
parity_requirements:

  # ---------------------------------------------------------------------------
  # Infrastructure Parity
  # ---------------------------------------------------------------------------
  infrastructure:
    description: "Infrastructure components must match"

    required_parity:
      - component: "Container runtime"
        requirement: "Same Docker version"
        tolerance: "patch version difference"

      - component: "Base images"
        requirement: "Identical images"
        tolerance: "none"

      - component: "Service versions"
        items:
          - "Redis version"
          - "RabbitMQ version"
          - "Vault version"
        requirement: "Same major.minor version"
        tolerance: "patch version difference"

    allowed_differences:
      - name: "Resource allocation"
        reason: "Cost optimization in non-prod"
        documentation_required: true

      - name: "Replica count"
        reason: "HA not needed in dev"
        documentation_required: true

  # ---------------------------------------------------------------------------
  # Configuration Parity
  # ---------------------------------------------------------------------------
  configuration:
    description: "Configuration approach must be consistent"

    requirements:
      same_config_format:
        description: "Use same configuration file format everywhere"
        format: "YAML"

      same_config_keys:
        description: "Same configuration keys in all environments"
        enforcement: "schema validation"

      environment_specific_values:
        allowed: true
        must_be_explicit: true
        location: "environment-specific config files"

    config_files:
      base: "config/base.yaml"
      overrides:
        development: "config/development.yaml"
        staging: "config/staging.yaml"
        production: "config/production.yaml"

  # ---------------------------------------------------------------------------
  # Code Parity
  # ---------------------------------------------------------------------------
  code:
    description: "Same code must run in all environments"

    requirements:
      same_codebase:
        description: "Identical application code"
        enforcement: "git SHA tracking"

      no_environment_conditionals:
        description: "Avoid if (env == 'production') patterns"
        exceptions:
          - "Logging verbosity"
          - "Debug endpoints"
        enforcement: "code review"

      same_dependencies:
        description: "Same dependency versions"
        enforcement: "lock files"

  # ---------------------------------------------------------------------------
  # Data Parity
  # ---------------------------------------------------------------------------
  data:
    description: "Data handling must be consistent"

    schema_parity:
      requirement: "Same database schema"
      enforcement: "migration scripts"

    data_differences:
      allowed:
        - "Production has real data"
        - "Staging has anonymized/synthetic data"
        - "Development has minimal test data"

    seed_data:
      staging: "Anonymized production snapshot"
      development: "Minimal fixtures"
      refresh_frequency:
        staging: "weekly"
        development: "on demand"

# =============================================================================
# Docker Parity
# =============================================================================
docker:

  compose_files:
    base: "docker-compose.yml"
    overrides:
      development: "docker-compose.dev.yml"
      staging: "docker-compose.staging.yml"
      production: "docker-compose.prod.yml"

  image_policy:
    use_same_images: true
    tag_strategy:
      development: "latest or branch tag"
      staging: "release candidate tag"
      production: "versioned tag"

  volume_handling:
    development:
      allow_bind_mounts: true
      reason: "Fast iteration"
    staging:
      allow_bind_mounts: false
      use_volumes: true
    production:
      allow_bind_mounts: false
      use_volumes: true

# =============================================================================
# Secrets & Credentials
# =============================================================================
secrets:

  policy:
    description: "Secrets handling across environments"

    same_secret_names:
      requirement: true
      reason: "Code doesn't need environment awareness"

    different_values:
      requirement: true
      reason: "Security isolation"

    access_method:
      all_environments: "HashiCorp Vault"
      development_exception: "Local .env file allowed for convenience"

  vault_paths:
    development: "secret/data/dev/agent/*"
    staging: "secret/data/staging/agent/*"
    production: "secret/data/prod/agent/*"

# =============================================================================
# Networking Parity
# =============================================================================
networking:

  service_discovery:
    method: "Docker DNS / Kubernetes Services"
    same_service_names: true

  ports:
    internal: "Same across environments"
    external: "May differ based on infrastructure"

  tls:
    development: "Self-signed certificates allowed"
    staging: "Real certificates required"
    production: "Real certificates required"

# =============================================================================
# Monitoring & Logging Parity
# =============================================================================
observability:

  logging:
    same_format: true
    format: "JSON structured logging"

    differences_allowed:
      - name: "Log level"
        development: "DEBUG"
        staging: "INFO"
        production: "INFO or WARN"

      - name: "Log destination"
        development: "stdout"
        staging: "aggregation service"
        production: "aggregation service"

  metrics:
    same_metrics_collected: true
    same_metric_names: true

    differences_allowed:
      - name: "Retention period"
      - name: "Alert thresholds"

  tracing:
    same_instrumentation: true
    sampling_rate:
      development: 1.0  # All traces
      staging: 0.1      # 10% sampling
      production: 0.01  # 1% sampling

# =============================================================================
# Parity Verification
# =============================================================================
verification:

  automated_checks:
    - name: "Docker image comparison"
      frequency: "on_deployment"
      check: "Same image digest in staging and production"

    - name: "Configuration schema validation"
      frequency: "on_change"
      check: "All environments have same config keys"

    - name: "Dependency lock file comparison"
      frequency: "on_change"
      check: "Lock files match"

    - name: "Service version check"
      frequency: "daily"
      check: "Infrastructure service versions match"

  manual_checks:
    frequency: "monthly"
    checklist:
      - "Review documented differences"
      - "Verify differences are still justified"
      - "Check for drift"
      - "Update documentation"

  drift_detection:
    enabled: true
    frequency: "daily"
    alert_on: "undocumented differences"
    action: "create_task_to_resolve"

# =============================================================================
# Documented Differences
# =============================================================================
documented_differences:
  description: >
    All intentional differences between environments must be documented here.

  differences:
    - id: "DIFF-001"
      category: "resources"
      description: "Reduced resource allocation in development"
      environments: [development]
      justification: "Cost savings, local resource constraints"
      risk: "low"
      mitigation: "Staging matches production resources"

    - id: "DIFF-002"
      category: "data"
      description: "Synthetic data in non-production"
      environments: [development, staging]
      justification: "Privacy, data protection"
      risk: "medium"
      mitigation: "Data generation mimics production patterns"

    - id: "DIFF-003"
      category: "security"
      description: "Development Vault in dev mode"
      environments: [development]
      justification: "Simplified local setup"
      risk: "low"
      mitigation: "Never use dev mode in staging/production"

# =============================================================================
# Enforcement
# =============================================================================
enforcement:

  ci_cd_gates:
    - "Block deployment if parity check fails"
    - "Require documented justification for differences"
    - "Alert on drift detection"

  review_requirements:
    - "Infrastructure changes require parity review"
    - "New configuration keys require all-environment update"
    - "Dependency updates must apply to all environments"

  exceptions:
    process: "Document in DIFF-XXX format above"
    approval: "Required for production differences"
    review: "Quarterly review of all exceptions"
